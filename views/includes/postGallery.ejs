<link rel="stylesheet" href="/assets/css/bootstrap-table.min.css">
<script src="/assets/js/bootstrap-table.min.js"></script>

<div class="container-fluid">
    <div class="row">
        <div class=" container-fluid">
            <link rel="stylesheet" href="/assets/css/bootstrap-table.min.css">
            <script src="/assets/js/bootstrap-table.min.js"></script>

            <div id="toolbar">
                <button id='createPost' type="button" class="btn btn-success my-2 my-sm-0"
                    onclick="window.location.href='/admin/addPost'">ساخت نوشته</button>
                <button id='deletePost' type="button" class="btn btn-danger my-2 my-sm-0">حذف</button>
                <button id='aprovePost' type="button" class="btn btn-info my-2 my-sm-0">تایید</button>

            </div>
            <table id="table" data-toggle="table" data-flat="true" data-search="true" data-height='500'
                data-toolbar="#galleryToolbar" data-url="http://localhost:3000/admin/postData">
                <thead>
                    <tr>
                        <th data-field="postName" data-sortable="true">نام</th>
                        <th data-field="createdAt" data-sortable="true">زمان ساخت</th>
                        <th data-field="path" data-sortable="true">آدرس</th>
                        <th data-field="path" data-formatter="editRow">ویراش</th>
                        <th data-field="aproved" data-formatter="aproveRow">تایید</th>
                        <th data-field="state" data-checkbox="true"></th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>
<script>

    function editRow(value, row, index) {
        return [
            `<button id='editPost' onclick="editPost(this)" type="button" class="btn btn-info m-0 p-1">ویرایش</button>`
        ].join('');
    }
    function aproveRow(value, row, index) {
        if (value === false) {
            return ` <p class=' m-0 p-1 text-danger font-weight-bold border rounded border-danger
                                    d-inline-flex bg-white'>تایید نشده
                                    </p>`
        } else { return ` <p class=' m-0 p-1 text-danger font-weight-bold border rounded border-danger
                                    d-inline-flex bg-white'>تایید نشده
                                    </p>`}

    }

    const remove = $('#deletePost')
    const edit = $('#editPost')
    const table = $('#table')

    function editPost(e) {
        const postName = e.parentElement.parentElement.firstChild.innerText
        window.location.href = `/admin/updatePost/${postName}`
    }

    function aprovePost(e) {
        const postName = e.parentElement.parentElement.firstChild.innerText
        $.ajax({
            type: 'POST', url: `/admin/posts/aprovePost/${postName}`
            , success: function (result) {
                console.log(result)
                window.location.replace('/admin/posts')
            }
        })
    }


    $(function () {
        table.on('check.bs.table uncheck.bs.table check-all.bs.table uncheck-all.bs.table', function () {
            remove.prop('disabled', !table.bootstrapTable('getSelections').length)
        })
        remove.click(function () {

            var ids = $.map(table.bootstrapTable('getSelections'), function (row) {
                console.log(row.postName, 'asdadadadas')
                fetch(`/admin/delete/post/${row.postName}`, {
                    method: "DELETE",
                    headers: {
                    },
                })
                    .then((response) => {
                        return response.json();
                    })
                    .then((result) => {
                        console.log(result)
                    })
                    .catch((err) => {
                        console.log(err);
                    });
                return row.id
            })
            table.bootstrapTable('remove', {
                field: 'id',
                values: ids
            })
            remove.prop('disabled', true)
        })

    })

</script>